---
import i18next from 'i18next'
import { remark } from 'remark'
import { visit } from 'unist-util-visit'
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from '@/components/ui/card'
import { H1, H2, Lead } from '@/components/ui/typography'
import { t } from '@/i18n/ui'
import BaseLayout from '@/layouts/BaseLayout.astro'
import { getI18nStaticPaths } from '@/lib/i18n-utils'
import creditsMd from '../../credits.md?raw'

export async function getStaticPaths() {
  return getI18nStaticPaths()
}

const locale = Astro.params.locale
i18next.changeLanguage(locale)

const tree = remark().parse(creditsMd)

type Technology = {
  name: string
  url: string
  description: string
}

type Category = {
  name: string
  technologies: Technology[]
}

const categories: Category[] = []
let currentCategory: Category | null = null
let currentTech: Technology | null = null

visit(tree, (node: any) => {
  if (node.type === 'heading' && node.depth === 2) {
    const textNode: any = node.children[0]
    const name = textNode.value ?? textNode.children?.[0]?.value ?? ''
    currentCategory = { name, technologies: [] }
    categories.push(currentCategory!)
  }
 else if (node.type === 'heading' && node.depth === 3) {
    const link: any = node.children[0]
    if (link.type === 'link') {
      const linkText: any = link.children[0]
      currentTech = {
        name: linkText.value,
        url: link.url,
        description: '',
      }
      currentCategory!.technologies.push(currentTech)
    }
  }
 else if (node.type === 'paragraph' && currentTech) {
    const textNode: any = node.children[0]
    currentTech.description = textNode.value ?? ''
    currentTech = null
  }
})
---

<BaseLayout title={t('credits.title')}>
  <H1>{t('credits.title')}</H1>
  <Lead className="mt-6">
    {t('credits.description')}
  </Lead>
  <div class="mt-6 space-y-6">
    {
      categories.map((category: Category) => (
        <div>
          <H2>{category.name}</H2>
          <div
            class={`
              mt-6 grid gap-4
              md:grid-cols-2
              lg:grid-cols-3
            `}
          >
            {category.technologies.map((tech: Technology) => (
              <a
                href={tech.url}
                target="_blank"
                rel="noopener noreferrer"
                class={`
                  transition-shadow
                  hover:shadow-lg
                `}
              >
                <Card className="h-full">
                  <CardHeader>
                    <CardTitle>{tech.name}</CardTitle>
                  </CardHeader>
                  <CardContent>
                    <CardDescription>
                      {tech.description}
                      <p class="mt-3 break-all text-primary">{tech.url}</p>
                    </CardDescription>
                  </CardContent>
                </Card>
              </a>
            ))}
          </div>
        </div>
      ))
    }
  </div>
</BaseLayout>
