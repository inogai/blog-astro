---
import { getCollection, render } from 'astro:content'
import i18next from 'i18next'
import PostNavigation from '@/components/PostNavigation.astro'
import { TableOfContents } from '@/components/TableOfContents'
import { t } from '@/i18n/ui'
import BaseLayout from '@/layouts/BaseLayout.astro'
import { getI18nStaticPaths } from '@/lib/i18n-utils'

export async function getStaticPaths() {
  const posts = await getCollection('blog')
  return getI18nStaticPaths(
    posts.map(post => ({ id: post.data.id, props: { post } })),
  )
}

const locale = Astro.params.locale
i18next.changeLanguage(locale)

const { post } = Astro.props
const { Content, headings } = await render(post)

const sortedPosts = (await getCollection('blog')).sort(
  (a, b) =>
    new Date(a.data.created).getTime() - new Date(b.data.created).getTime(),
)

const postIdx = sortedPosts.findIndex(p => p.data.id === post.data.id)
const nextPost
  = postIdx < sortedPosts.length - 1 ? sortedPosts[postIdx + 1] : null
const prevPost = postIdx > 0 ? sortedPosts[postIdx - 1] : null
---

<BaseLayout
  title={post.data.title}
  breadcrumb={{
    overrides: [
      {
        href: Astro.url.pathname,
        label: post.data.title,
      },
    ],
  }}
>
  <div class="flex flex-col gap-8 lg:flex-row">
    <details
      class={`
        group rounded border bg-secondary px-4 text-secondary-foreground
        lg:hidden
      `}
    >
      <summary
        class={`
          cursor-pointer py-4 text-sm font-medium
          hover:underline hover:opacity-80
          active:underline active:opacity-80
        `}
      >
        {t('blog.tableOfContents')}
      </summary>
      <div class="mb-4">
        <TableOfContents headings={headings} client:load />
      </div>
    </details>
    <aside class="hidden w-64 flex-shrink-0 lg:block">
      <TableOfContents headings={headings} client:load />
    </aside>
    <article class="min-w-0 flex-1">
      <h1 class="mb-4 text-5xl font-extrabold">{post.data.title}</h1>
      <p class="mb-8 text-sm">
        {t('blog.created')}
        {new Date(post.data.created).toLocaleDateString()}
        {
          post.data.updated !== post.data.created && (
            <span class="ml-2">
              {t('blog.updated')}
              {new Date(post.data.updated).toLocaleDateString()}
            </span>
          )
        }
      </p>
      <div class="prose max-w-none">
        <Content />
      </div>
      <PostNavigation prevPost={prevPost} nextPost={nextPost} />
      <div>
        <script is:inline>
        var remark_config = {
          host: 'https://remark42.inogai.com',
          site_id: 'remark',
        }
        </script>
        <script is:inline>!(function (e, n) { for (let o = 0; o < e.length; o++) { const r = n.createElement('script'); let c = '.js'; const d = n.head || n.body; 'noModule' in r ? (r.type = 'module', c = '.mjs') : r.async = !0, r.defer = !0, r.src = `${remark_config.host}/web/${e[o]}${c}`, d.appendChild(r) } }(remark_config.components || ['embed'], document))
        </script>
        <div id="remark42"></div>
      </div>
    </article>
  </div>
</BaseLayout>
