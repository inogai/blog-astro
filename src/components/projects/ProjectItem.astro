---
import type { Project } from '@/types/Project'
import { Icon } from 'astro-icon/components'
import { buildBadges } from '@/lib/badge-builder'
import Badge from './Badge.astro'
import TechStack from './TechStack.astro'

interface Props {
  project: Project
  showDetailLink?: boolean
}

const { project, showDetailLink = false } = Astro.props
const { title, description, techStack, github, demo, featured, status, image }
  = project.data

const locale = Astro.params.locale || 'en'
const detailHref = `/${locale}/projects/${project.id}/`

// Determine the primary link
const primaryLink = showDetailLink ? detailHref : github || demo

const badges = buildBadges({
  featured,
  status,
  github,
})
---

<div
  class:list={[
    'group -mx-3 block rounded-lg px-3 py-4 transition-colors',
    'hover:bg-muted/50',
    'relative overflow-hidden',
  ]}
>
  <!-- An overlaid link that covers the entire card -->
  <a
    href={primaryLink}
    target={showDetailLink ? '_self' : '_blank'}
    rel={showDetailLink ? '' : 'noopener noreferrer'}
    class="absolute inset-0 z-10"
  >
    <span class="sr-only">{title}</span>
  </a>
  <div class="relative flex items-start justify-between gap-4">
    <div class="min-w-0 flex-1">
      <div class="flex items-center gap-2">
        <h3 class="text-lg font-medium group-hover:underline">
          {title}
        </h3>
        <!-- Ensure badges are above the overlaid link -->
        {badges.map(({ type }) => <Badge type={type} class="relative z-20" />)}
      </div>
      <p class="mt-1 line-clamp-2 text-muted-foreground">
        {description}
      </p>
      <div class="mt-2">
        <TechStack items={techStack} />
      </div>
    </div>
    <div
      class={`
        shrink-0 text-muted-foreground transition-colors
        group-hover:text-foreground
      `}
    >
      {
        showDetailLink
? (
          <Icon name="mdi:chevron-right" class="size-5" />
        )
: (
          <Icon name="mdi:arrow-top-right" class="size-5" />
        )
      }
    </div>
  </div>
  {
    image && (
      <div class="pointer-events-none absolute inset-0 z-0 hidden md:block">
        <img
          src={image}
          alt={title}
          loading="lazy"
          class="absolute top-0 right-24 bottom-0 h-full w-24 object-cover"
        />
        <div
          class="absolute inset-0"
          style={{
            background:
              'linear-gradient(to left, transparent 0%, transparent 50%, hsl(var(--card)) 100%)',
          }}
        />
      </div>
    )
  }
</div>
